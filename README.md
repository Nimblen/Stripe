

# Stripe Payment Integration

Проект для интеграции с платёжной системой Stripe. В проекте реализовано создание платёжных ссылок через Stripe Checkout и приём вебхуков для обработки событий (например, успешной оплаты). Пример написан на Python с использованием FastAPI и Celery для фоновой обработки задач.

## Содержание

* [Требования](#требования)
* [Установка](#установка)
* [Настройка](#настройка)
* [Запуск](#запуск)
* [Структура проекта](#структура-проекта)
* [Использование](#использование)
* [Поддержка](#поддержка)

## Требования

* Python 3.9+
* Stripe API ключ (можно получить в [Stripe Dashboard](https://dashboard.stripe.com/))
* Redis для работы с Celery

## Установка

1. Клонируйте репозиторий:
```bash
git clone https://github.com/ваш_проект.git
cd ваш_проект
```
Установите зависимости:
```bash
pip install -r requirements.txt
```

## Настройка

Создайте файл `.env` в корне проекта и добавьте в него ключ API для Stripe:
```env
STRIPE_API_KEY=sk_test_4eC39HqLyjWDarjtT1zdp7dc
STRIPE_ENDPOINT_SECRET=whsec_...
```
Убедитесь, что Redis запущен для работы Celery. В Docker это можно сделать так:
```bash
docker run -d -p 6379:6379 redis
```

## Запуск

Запустите сервер FastAPI:
```bash
uvicorn main:app --host 0.0.0.0 --port 8000
```
Запустите Celery воркера для фоновой обработки задач:
```bash
celery -A celery_config.celery_app worker --loglevel=info
```
Для локального тестирования вебхуков Stripe можно использовать ngrok для проброса порта:
```bash
ngrok http 8000
```
В Stripe Dashboard укажите URL вебхука: `https://your-ngrok-url/webhook`.

## Структура проекта

```
stripe/
├── .env              # Ключ API Stripe
├── server.py          # Основной файл FastAPI сервера
├── task.py         # Фоновые задачи Celery для обработки вебхуков
├── config.py        # Конфигурация API ключей и Celery
├── stripe_url.py    # Функция для создания платёжной ссылки
└── README.md        # Описание проекта
```

## Использование

Создание платёжной ссылки: вызовите функцию `create_checkout_session()` для генерации URL оплаты.

Получение вебхуков: FastAPI сервер будет получать уведомления от Stripe и передавать их на обработку в Celery. Все данные платежа и статус заказа можно обрабатывать в функции `process_webhook`.

## Поддержка

Если у вас есть вопросы или требуется помощь, создайте Issue в репозитории или свяжитесь с нами.

### Пояснения

* **Требования**: Указываются версии Python и зависимости, такие как Redis и Stripe API ключи.
* **Установка и Настройка**: Пошаговые инструкции по установке, настройке переменных окружения и запуску Redis.
* **Запуск**: Поясняет, как запустить FastAPI и Celery, и использовать `ngrok` для локального тестирования вебхуков.
* **Структура проекта**: Краткий обзор файлов проекта.
* **Использование**: Основные функции для создания ссылки оплаты и приёма вебхуков.